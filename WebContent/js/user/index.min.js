layui.config({base:basePath+"js/",version:(new Date).getTime()});layui.use(["laypage","layer","table","element","slider","commons","combo","form","upload"],function(){var e=0;var t=layui.laypage,a=layui.layer,l=layui.table,i=layui.element,n=layui.slider,o=layui.form,r=layui.commons(),s=layui.jquery,d=layui.combo(),c=layui.upload;var u=s(window).height()-10+"px";s("#ztree0").height(s(window).height()-100);var f=true;var p=a.load(1,{shade:[.5,"#ccc"]});l.render({id:"userTable",elem:"#demo",height:"full-0",method:"post",url:"queryPage.do",title:"角色列表",limit:10,limits:[10,15,20,30,50,100],page:{layout:["limit","prev","page","next","skip","count"],groups:5},toolbar:"#toolbar",defaultToolbar:[],totalRow:false,cols:[[{type:"checkbox",fixed:"left"},{type:"numbers",title:"序号",align:"center",width:60},{field:"department",title:"部门",width:120,align:"center"},{field:"workShop",title:"科室/车间",width:120,align:"center"},{field:"dept",title:"班组",width:120,align:"center"},{field:"usercode",title:"工号",width:120,align:"center"},{field:"name",title:" 姓名",width:120,align:"center"},{field:"role",title:"角色",width:150,align:"center"},{field:"remark",title:"备注",width:180,align:"center"},{field:"state",title:"状态",width:110,templet:"#state"}]],done:function(e){a.close(p);s("#query").val(name);if(f){c.render({elem:s("#importExcel"),url:"importYC2GW.do",accept:"file",field:"filename",acceptMime:".xlsx",exts:"xlsx",multiple:true,before:function(e){a.load()},done:function(e){a.closeAll();if(e.flag){r.showInfo(e.message);reloadTable();return}a.msg(e.message)}});f=false}try{d.set({elem:"roles",url:"../role/queryall.do"}).render()}catch(e){a.msg(e.message)}}});window.reloadTable=function(e){f=true;p=a.load(1,{shade:[.5,"#ccc"]});var t={};name=t.query=s("#query").val();if(e!=undefined){s.extend(true,t,e)}l.reload("userTable",{where:t})};var m={view:{dblClickExpand:false,showLine:true,fontCss:{color:"black","font-weight":"bold"},selectedMulti:true},check:{chkboxType:{Y:"s",N:"s"},chkStyle:"checkbox",enable:true},data:{key:{url:"undefined"},simpleData:{enable:true,idKey:"id",pIdKey:"parentId",rootPId:null}}};var g,y,h;var b=function(e){s.ajax({type:"post",url:"../department/queryDept.do?id="+e,dateType:"json",contentType:"application/json",success:function(e){g=s.fn.zTree.init(s("#ztree0"),m,e.data)}})};o.on("submit(formSubmit)",function(t){var l=JSON.stringify(t.field);var i="create.do";if(t.field.id){i="update.do"}s.ajax({type:"post",url:i,dateType:"json",contentType:"application/json",data:l,success:function(t){if(t.flag){a.close(e);reloadTable({});r.showInfo(t.message);return}a.msg(t.message)}});return false});o.on("submit(formSubmit3)",function(t){var i=l.checkStatus("userTable").data[0].id;var n=g.getCheckedNodes().map(function(e){return e.id}).toString();s.ajax({type:"post",url:"../role/addDept.do?id="+i+"&ids="+n,dateType:"json",contentType:"application/json",success:function(t){r.showInfo(t.message);a.close(e)}});return false});s(".btn-cancel").click(function(t){a.close(e)});l.on("toolbar(test)",function(t){var i=l.checkStatus(t.config.id),n=i.data;switch(t.event){case"addDept":if(n.length===0){a.msg("请选择一行")}else if(n.length>1){a.msg("只能同时编辑一个")}else{e=a.open({type:1,offset:["1px"],content:s("#dlg4"),title:"关联部门",area:["500px",u],cancel:function(){s("#dlg4").hide()}});b(n[0].id)}break;case"query":reloadTable();break;case"updateRole":if(n.length==0){a.msg("没有选中数据");return}var o=s("#roles").val();if(o===undefined||o==""){a.msg("没有选择角色");return}var d=n.map(function(e){return e.id}).toString();s.ajax({type:"post",url:"updateRole.do",dateType:"json",contentType:"application/json",data:JSON.stringify({roleId:o,ids:d}),success:function(e){if(e.flag){r.showInfo(e.message);reloadTable();return}a.msg(e.message)}});break;case"resetPassword":if(n.length==0){a.msg("没有选中数据");return}var d=n.map(function(e){return e.id}).toString();s.ajax({type:"post",url:"resetPassword.do?ids="+d,dateType:"json",contentType:"application/json",success:function(e){if(e.flag){r.showInfo(e.message);return}a.msg(e.message)}});break;case"downloadfile":s("#download").attr("src","downloadYC2GWTemplate.do");break}})});